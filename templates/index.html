<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vorixa - Lead Scraper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .loader {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.4s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col antialiased selection:bg-black selection:text-white">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 sm:px-6">
            <div class="flex justify-between h-14 items-center">
                <div class="flex items-center gap-2">
                    <img src="{{ url_for('static', filename='favicon.png') }}" class="h-8 w-auto object-contain"
                        alt="Vorixa Logo">
                    <span class="font-bold text-lg tracking-tight">Vorixa</span>
                </div>
                <div class="flex items-center">
                    <span
                        class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-[10px] font-medium bg-green-50 text-green-700 border border-green-100">
                        <span class="relative flex h-1.5 w-1.5">
                            <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span>
                        </span>
                        Operational
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center pt-8 pb-12 px-4">

        <!-- Hero Section -->
        <div class="text-center max-w-xl mx-auto mb-8 space-y-3 fade-in-up">
            <h1 class="text-3xl font-bold tracking-tight text-gray-900">
                Find Your Next Customer
            </h1>
            <p class="text-sm text-gray-500 leading-relaxed">
                Extract verified business leads from Google Maps in seconds.
            </p>
        </div>

        <!-- Main Card -->
        <div class="w-full max-w-xl bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden fade-in-up"
            style="animation-delay: 0.1s;">
            <div class="p-6 sm:p-8">
                <form id="scrapeForm" class="space-y-6">
                    <input type="hidden" name="target" value="maps">

                    <div class="space-y-5">
                        <!-- Keyword Input -->
                        <div class="space-y-1.5">
                            <label for="keyword"
                                class="block text-xs font-bold text-gray-700 uppercase tracking-wide">Target Industry /
                                Niche</label>
                            <div class="relative">
                                <div
                                    class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <input type="text" name="keyword" id="keyword" required
                                    class="block w-full pl-9 pr-3 py-2.5 bg-gray-50 border border-gray-200 text-gray-900 rounded-lg focus:ring-1 focus:ring-black focus:border-black focus:bg-white transition-all text-sm placeholder-gray-400"
                                    placeholder="e.g. Coffee Shops in Brooklyn">
                            </div>
                        </div>

                        <!-- Max Results Input -->
                        <div class="space-y-1.5">
                            <label for="max_results"
                                class="block text-xs font-bold text-gray-700 uppercase tracking-wide">Number of
                                Leads</label>
                            <div class="relative">
                                <div
                                    class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                </div>
                                <input type="number" name="max_results" id="max_results" value="10" min="1" max="500"
                                    class="block w-full pl-9 pr-3 py-2.5 bg-gray-50 border border-gray-200 text-gray-900 rounded-lg focus:ring-1 focus:ring-black focus:border-black focus:bg-white transition-all text-sm">
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn"
                        class="w-full flex justify-center items-center py-3 px-4 border border-transparent text-sm font-bold rounded-lg text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 transition-all shadow-md active:scale-[0.99] disabled:opacity-70 disabled:cursor-wait">
                        <span>Start Extraction</span>
                    </button>

                    <!-- Simplified Trust Signals -->
                    <div class="flex justify-center items-center gap-4 text-xs text-gray-400 pt-2">
                        <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor"
                                viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                    clip-rule="evenodd"></path>
                            </svg> Verified Data</span>
                        <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor"
                                viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                    clip-rule="evenodd"></path>
                            </svg> Secure</span>
                    </div>
                </form>

                <!-- Status & Feedback -->
                <div id="statusMessage" class="hidden mt-6 p-4 rounded-xl bg-gray-50 border border-gray-200 fade-in-up">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
                        <div class="flex items-center gap-3 text-left">
                            <div id="statusIcon" class="text-lg"></div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-900" id="msgTitle">Status</h4>
                                <p class="text-xs text-gray-500" id="msgText">Initializing...</p>
                            </div>
                        </div>
                        <div id="downloadContainer" class="hidden">
                            <a id="downloadLink" href="#"
                                class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-xs font-bold rounded-lg transition-colors shadow-sm">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Download Excel
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Results Table -->
        <div id="resultsTableContainer" class="hidden w-full max-w-7xl mt-10 fade-in-up pb-10">
            <div class="flex items-center justify-between mb-4 px-2">
                <h3 class="text-base font-bold text-gray-900">Results</h3>
                <div class="flex items-center gap-2">
                    <button id="prevPageBtn"
                        class="p-1.5 text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50"><svg
                            class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                            </path>
                        </svg></button>
                    <span id="pageIndicator"
                        class="text-xs font-mono font-medium text-gray-500 bg-white px-2 py-1 border border-gray-200 rounded">1/1</span>
                    <button id="nextPageBtn"
                        class="p-1.5 text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50"><svg
                            class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg></button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left text-gray-500">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-50 border-b border-gray-100">
                            <tr id="tableHead"></tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-4xl mx-auto py-6 px-4 text-center">
            <p class="text-xs text-gray-400">Â© 2025 Vorixa. <span class="mx-1">â€¢</span> Made by <a
                    href="https://flowreativ.com" target="_blank"
                    class="font-medium hover:text-gray-600 transition-colors">flowreativ.com teams</a></p>
        </div>
    </footer>

    <script>
        let allResults = [];
        let currentPage = 1;
        const resultsPerPage = 10;

        function exportToCSV(data) {
            const replacer = (key, value) => value === null ? '' : value;
            const header = Object.keys(data[0]);
            let csv = data.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(','));
            csv.unshift(header.join(','));
            csv = csv.join('\r\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'leads_export.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                console.warn("SheetJS not loaded, falling back to basic CSV");
                exportToCSV(allResults);
                return;
            }
            if (allResults.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(allResults);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Leads");
            XLSX.writeFile(wb, "Leads_Result.xlsx");
        }

        document.getElementById('downloadLink').addEventListener('click', function (e) {
            e.preventDefault();
            exportToExcel();
        });

        document.getElementById('scrapeForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const originalBtnContent = submitBtn.innerHTML;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loader mr-2"></div><span>Run</span>';
            submitBtn.classList.add('cursor-wait');

            const statusDiv = document.getElementById('statusMessage');
            statusDiv.classList.add('hidden');
            document.getElementById('resultsTableContainer').classList.add('hidden');

            allResults = [];
            currentPage = 1;

            const formData = new FormData(this);

            try {
                const response = await fetch('/scrape', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                const msgTitle = document.getElementById('msgTitle');
                const msgText = document.getElementById('msgText');
                const statusIcon = document.getElementById('statusIcon');
                const downloadContainer = document.getElementById('downloadContainer');

                statusDiv.classList.remove('hidden');

                if (data.status === 'success') {
                    statusDiv.className = "mt-6 p-4 rounded-xl bg-green-50 border border-green-100 fade-in-up";
                    msgTitle.textContent = "Done";
                    msgTitle.className = "text-sm font-bold text-green-800";
                    msgText.textContent = data.message;
                    msgText.className = "text-xs text-green-600";
                    statusIcon.innerHTML = "âœ…";

                    if (data.results && data.results.length > 0) {
                        allResults = data.results;
                        downloadContainer.classList.remove('hidden');
                        renderTablePage(1);
                    }
                } else {
                    const isError = data.status === 'danger';
                    statusDiv.className = `mt-6 p-4 rounded-xl border fade-in-up ${isError ? 'bg-red-50 border-red-100' : 'bg-yellow-50 border-yellow-100'}`;
                    msgTitle.textContent = isError ? "Error" : "Info";
                    msgTitle.className = `text-sm font-bold ${isError ? 'text-red-800' : 'text-yellow-800'}`;
                    msgText.textContent = data.message;
                    msgText.className = `text-xs ${isError ? 'text-red-600' : 'text-yellow-600'}`;
                    statusIcon.innerHTML = isError ? "âŒ" : "âš ï¸";
                    downloadContainer.classList.add('hidden');
                }

            } catch (error) {
                console.error(error);
                statusDiv.classList.remove('hidden');
                statusDiv.className = "mt-6 p-4 rounded-xl bg-red-50 border border-red-100 fade-in-up";
                document.getElementById('msgTitle').textContent = "Connection Error";
                document.getElementById('msgText').textContent = "Check terminal/console.";
                document.getElementById('statusIcon').innerHTML = "ðŸ”Œ";
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.classList.remove('cursor-wait');
            }
        });

        function renderTablePage(page) {
            currentPage = page;
            const tableContainer = document.getElementById('resultsTableContainer');
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            const pageIndicator = document.getElementById('pageIndicator');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            const start = (page - 1) * resultsPerPage;
            const end = start + resultsPerPage;
            const pageData = allResults.slice(start, end);
            const totalPages = Math.ceil(allResults.length / resultsPerPage);

            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            if (pageData.length === 0) return;

            const displayKeys = ['name', 'category', 'rating', 'review_count', 'phone', 'website', 'address'];

            displayKeys.forEach(key => {
                const th = document.createElement('th');
                th.className = "px-4 py-3 font-semibold text-gray-900 whitespace-nowrap bg-gray-50/50";
                th.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                tableHead.appendChild(th);
            });

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors border-b border-gray-50";

                displayKeys.forEach(key => {
                    const td = document.createElement('td');
                    td.className = "px-4 py-3 text-gray-700 whitespace-nowrap";

                    const value = row[key] || '-';

                    if (key === 'website' && row[key] && row[key] !== 'Not Found') {
                        td.innerHTML = `<a href="${row[key]}" target="_blank" class="text-blue-600 hover:underline">Link</a>`;
                    } else if (key === 'rating') {
                        td.innerHTML = `<span class="text-orange-500 font-bold">â˜… ${value}</span>`;
                    } else {
                        td.textContent = value;
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            pageIndicator.textContent = `${currentPage}/${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            tableContainer.classList.remove('hidden');
            if (page === 1) tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        document.getElementById('prevPageBtn').addEventListener('click', () => {
            if (currentPage > 1) renderTablePage(currentPage - 1);
        });

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            const totalPages = Math.ceil(allResults.length / resultsPerPage);
            if (currentPage < totalPages) renderTablePage(currentPage + 1);
        });
    </script>
</body>

</html>